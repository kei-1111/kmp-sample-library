name: Release XCFramework

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    runs-on: macos-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '16.2'

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build and Package XCFrameworks
        run: |
          ./gradlew :shared:packageXCFramework :feature:home:packageXCFramework

      - name: Read checksums
        id: checksums
        run: |
          SHARED_CHECKSUM=$(cat shared/build/outputs/checksum.txt)
          HOME_CHECKSUM=$(cat feature/home/build/outputs/checksum.txt)
          echo "shared_checksum=$SHARED_CHECKSUM" >> $GITHUB_OUTPUT
          echo "home_checksum=$HOME_CHECKSUM" >> $GITHUB_OUTPUT
          echo "ğŸ“‹ Shared Checksum: $SHARED_CHECKSUM"
          echo "ğŸ“‹ Home Checksum: $HOME_CHECKSUM"

      - name: Update Package.swift with checksums
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          SHARED_CHECKSUM=$(cat shared/build/outputs/checksum.txt)
          HOME_CHECKSUM=$(cat feature/home/build/outputs/checksum.txt)

          # Package.swiftã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¨ãƒã‚§ãƒƒã‚¯ã‚µãƒ ã‚’æ›´æ–°
          sed -i.bak "s|/releases/download/v[0-9.]*|/releases/download/v${VERSION}|g" Package.swift

          # awkã‚’ä½¿ç”¨ã—ã¦Sharedã¨Homeã®ãƒã‚§ãƒƒã‚¯ã‚µãƒ ã‚’å€‹åˆ¥ã«æ›´æ–°
          awk -v shared_checksum="$SHARED_CHECKSUM" -v home_checksum="$HOME_CHECKSUM" '
          /name: "Shared"/ { in_shared = 1 }
          /name: "Home"/ { in_shared = 0; in_home = 1 }
          /checksum:/ {
              if (in_shared) {
                  print "            checksum: \"" shared_checksum "\""
                  in_shared = 0
                  next
              } else if (in_home) {
                  print "            checksum: \"" home_checksum "\""
                  in_home = 0
                  next
              }
          }
          { print }
          ' Package.swift > Package.swift.tmp

          mv Package.swift.tmp Package.swift
          rm -f Package.swift.bak

          echo "âœ… Package.swift ã‚’æ›´æ–°ã—ã¾ã—ãŸ"

      - name: Commit and push Package.swift
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add Package.swift

          # Package.swiftã«å¤‰æ›´ãŒã‚ã‚Œã°ã‚³ãƒŸãƒƒãƒˆ
          if ! git diff --staged --quiet; then
            git commit -m "chore: Package.swiftã‚’${{ github.ref_name }}ã®ãƒã‚§ãƒƒã‚¯ã‚µãƒ ã§æ›´æ–°"

            # ã‚¿ã‚°ã‚’æ–°ã—ã„ã‚³ãƒŸãƒƒãƒˆã«ç§»å‹•
            git tag -f ${{ github.ref_name }}

            # ãƒ—ãƒƒã‚·ãƒ¥ï¼ˆã‚¿ã‚°ã‚‚å¼·åˆ¶æ›´æ–°ï¼‰
            git push origin HEAD:main
            git push -f origin ${{ github.ref_name }}

            echo "âœ… Package.swiftã‚’ã‚³ãƒŸãƒƒãƒˆã—ã¦ã‚¿ã‚°ã‚’æ›´æ–°ã—ã¾ã—ãŸ"
          else
            echo "â„¹ï¸ Package.swiftã«å¤‰æ›´ãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸ"
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            shared/build/outputs/Shared.xcframework.zip
            feature/home/build/outputs/Home.xcframework.zip
          body: |
            ## KMP Sample Library Release

            ### Swift Package Manager

            Xcodeã§ã“ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ç”¨ã™ã‚‹ã«ã¯ã€ä»¥ä¸‹ã®æ‰‹é †ã§è¿½åŠ ã—ã¦ãã ã•ã„ï¼š

            1. Xcode â†’ File â†’ Add Package Dependencies
            2. ãƒªãƒã‚¸ãƒˆãƒªURL: `https://github.com/kei-1111/kmp-sample-library`
            3. ãƒãƒ¼ã‚¸ãƒ§ãƒ³: `${{ github.ref_name }}`ã‚’é¸æŠ
            4. ä½¿ç”¨ã—ãŸã„ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’é¸æŠï¼ˆSharedã¾ãŸã¯Homeï¼‰

            ### XCFramework Checksums

            **Shared:**
            ```
            ${{ steps.checksums.outputs.shared_checksum }}
            ```

            **Home:**
            ```
            ${{ steps.checksums.outputs.home_checksum }}
            ```

            Package.swiftãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ‰‹å‹•ã§æ›´æ–°ã™ã‚‹å ´åˆã¯ã€ä¸Šè¨˜ã®checksumã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}